#include "detail/windows/x86/PAYDAY2/Payday2Handler.h"

#include <string_view>

#include "detail/LuaAPIImpl.h"
#include "detail/interface/IRuntimeCodeHook.h"
#include "detail/windows/x86/PAYDAY2/LuaReimplementation.h"
#include "detail/windows/x86/PAYDAY2/OnCloseStateHandler.h"
#include "detail/windows/x86/PAYDAY2/OnNewStateHandler.h"
#include "detail/windows/x86/PAYDAY2/OnTickHandler.h"

using namespace LuaHookNG;
using namespace std::literals;

static LuaFuncPtrs LoadLuaFunctions(IRuntimeCodeHook& codeHook) {
	LuaReimplementation::Init(codeHook);
	return LuaFuncPtrs{
	  codeHook.GetFuncRef(
		lua_newstate,
		"\x53\x8B\x5C\x24\x0C\x55\x8B\x6C\x24\x0C\x56\x57\x68\x40\x10\x00"sv,
		0x63FF30),
	  codeHook.GetFuncRef(
		lua_close,
		"\x8B\x44\x24\x04\x53\x56\x57\x8B\x78\x08\x8B\x77\x74\x56\xE8\x6D"sv,
		0x63F4F0),
	  codeHook.GetFuncRef(
		lua_newthread,
		"\x56\x8B\x74\x24\x08\x57\x8B\x4E\x08\x8B\x41\x14\x3B\x41\x18\x72\x07\x8B\xCE\xE8\x38\xB2\xFD\xFF"sv,
		0x640040),
	  codeHook.GetFuncRef(
		lua_gettop,
		"\x8B\x4C\x24\x04\x8B\x41\x14\x2B\x41\x10\xC1\xF8\x03\xC3"sv,
		0x63FBB0),
	  codeHook.GetFuncRef(
		lua_settop,
		"\x8B\x44\x24\x08\x85\xC0\x78\x5B\x53\x56\x8B\x74\x24\x0C\x57\x8B"sv,
		0x640BC0),
	  codeHook.GetFuncRef(
		lua_pushvalue,
		"\x56\x57\xFF\x74\x24\x10\x8B\x7C\x24\x10\x57\xE8\xF0\xDB\xFE\xFF"sv,
		0x640550),
	  codeHook.GetFuncRef(
		lua_remove,
		"\x8B\x4C\x24\x08\x56\x57\x85\xC9\x7E\x21\x8B\x7C\x24\x0C\x8B\x47"sv,
		0x640750),
	  codeHook.GetFuncRef(
		lua_insert,
		"\x8B\x4C\x24\x08\x56\x57\x85\xC9\x7E\x21\x8B\x54\x24\x0C\x8D\x71"sv,
		0x63FC50),
	  codeHook.GetFuncRef(
		lua_replace,
		"\x56\x8B\x74\x24\x08\xFF\x74\x24\x0C\x8B\x46\x14\x83\xE8\x08\x50"sv,
		0x6407B0),
	  codeHook.GetFuncRef(
		lua_checkstack,
		"\x8B\x54\x24\x08\x81\xFA\x40\x1F\x00\x00\x7F\x38\x8B\x4C\x24\x04"sv,
		0x63F4A0),
	  codeHook.GetFuncRef(
		lua_xmove,
		"\x53\x8B\x5C\x24\x08\x57\x8B\x7C\x24\x10\x3B\xDF\x74\x4B\x8B\x47"sv,
		0x640F60),
	  codeHook.GetFuncRef(
		lua_isnumber,
		"\x55\x8B\xEC\x83\xE4\xF8\x83\xEC\x08\xFF\x75\x0C\xFF\x75\x08\xE8\x7C\xE4\xFE\xFF"sv,
		0x63FCC0),
	  codeHook.GetFuncRef(
		lua_isstring,
		"\xFF\x74\x24\x08\xFF\x74\x24\x08\xE8\x33\xE4\xFE\xFF\x8B\x40\x04"sv,
		0x63FD10),
	  LuaReimplementation::lua_iscfunction,
	  codeHook.GetFuncRef(
		lua_isuserdata,
		"\xFF\x74\x24\x08\xFF\x74\x24\x08\xE8\x03\xE4\xFE\xFF\x8B\x40\x04"sv,
		0x63FD40),
	  codeHook.GetFuncRef(
		lua_type,
		"\x56\xFF\x74\x24\x0C\x8B\x74\x24\x0C\x56\xE8\x51\xD2\xFE\xFF\x8B"sv,
		0x640EF0),
	  codeHook.GetFuncRef(lua_typename,
						  "\x8B\x44\x24\x08\x8B\x04\x85\x50\x93\x97\x00"sv,
						  0x640F50),
	  codeHook.GetFuncRef(
		lua_equal,
		"\x56\x8B\x74\x24\x08\x57\xFF\x74\x24\x10\x56\xE8\x90\xEA\xFE\xFF"sv,
		0x63F6B0),
	  LuaReimplementation::lua_rawequal,
	  codeHook.GetFuncRef(
		lua_lessthan,
		"\x56\x8B\x74\x24\x08\x57\xFF\x74\x24\x10\x56\xE8\xD0\xE3\xFE\xFF"sv,
		0x63FD70),
	  codeHook.GetFuncRef(
		lua_tonumber,
		"\x55\x8B\xEC\x83\xE4\xF8\x83\xEC\x08\xFF\x75\x0C\xFF\x75\x08\xE8\xEC\xD2\xFE\xFF"sv,
		0x640E50),
	  codeHook.GetFuncRef(
		lua_tointeger,
		"\x55\x8B\xEC\x83\xE4\xF8\x83\xEC\x08\xFF\x75\x0C\xFF\x75\x08\xE8\x1C\xD4"sv,
		0x640D20),
	  codeHook.GetFuncRef(
		lua_toboolean,
		"\xFF\x74\x24\x08\xFF\x74\x24\x08\xE8\x43\xD4\xFE\xFF\x83\xC4\x08"sv,
		0x640D00),
	  codeHook.GetFuncRef(
		lua_tolstring,
		"\x83\xEC\x24\xA1\x74\xED\xA2\x00\x33\xC4\x89\x44\x24\x20\x53\x8B\x5C\x24\x2C"sv,
		0x640D80),
	  codeHook.GetFuncRef(
		lua_objlen,
		"\x83\xEC\x24\xA1\x74\xED\xA2\x00\x33\xC4\x89\x44\x24\x20\x8B\x44"sv,
		0x640160),
	  LuaReimplementation::lua_tocfunction,
	  LuaReimplementation::lua_touserdata,
	  LuaReimplementation::lua_tothread,
	  LuaReimplementation::lua_topointer,
	  codeHook.GetFuncRef(
		lua_pushnil,
		"\x8B\x4C\x24\x04\x8B\x41\x14\xC7\x40\x04\xFF\xFF\xFF\xFF\x83\x41"sv,
		0x640440),
	  codeHook.GetFuncRef(
		lua_pushnumber,
		"\x8B\x4C\x24\x04\xF2\x0F\x10\x44\x24\x08\x8B\x41\x14\xF2\x0F\x11"sv,
		0x640460),
	  codeHook.GetFuncRef(
		lua_pushinteger,
		"\x66\x0F\x6E\x44\x24\x08\x8B\x4C\x24\x04\xF3\x0F\xE6\xC0\x8B\x41"sv,
		0x640390),
	  codeHook.GetFuncRef(
		lua_pushlstring,
		"\x56\x8B\x74\x24\x08\x8B\x4E\x08\x8B\x41\x14\x3B\x41\x18\x72\x07\x8B\xCE\xE8\x89"sv,
		0x6403F0),
	  codeHook.GetFuncRef(
		lua_pushstring,
		"\x56\x8B\x74\x24\x08\x57\x8B\x7C\x24\x10\x85\xFF\x75\x0C\x8B\x46"sv,
		0x6404A0),
	  LuaReimplementation::lua_pushvfstring,
	  codeHook.GetFuncRef(
		lua_pushcclosure,
		"\x56\x8B\x74\x24\x08\x8B\x4E\x08\x8B\x41\x14\x3B\x41\x18\x72\x07\x8B\xCE\xE8\xA9"sv,
		0x6402D0),
	  codeHook.GetFuncRef(
		lua_pushboolean,
		"\x8B\x4C\x24\x04\x33\xC0\x39\x44\x24\x08\xBA\xFE\xFF\xFF\xFF\x0F"sv,
		0x6402A0),
	  codeHook.GetFuncRef(
		lua_pushlightuserdata,
		"\x8B\x4C\x24\x04\x8B\x44\x24\x08\x8B\x51\x14\x89\x02\xC7\x42\x04"sv,
		0x6403C0),
	  codeHook.GetFuncRef(
		lua_pushthread,
		"\x56\x8B\x74\x24\x08\x8B\x46\x14\x89\x30\xC7\x40\x04\xF9\xFF\xFF"sv
		"\xFF\x83\x46\x14\x08\x8B\x46\x14\x3B\x46\x18\x72\x07\x8B\xCE\xE8\x5C"sv,
		0x640510),
	  codeHook.GetFuncRef(
		lua_gettable,
		"\x56\xFF\x74\x24\x0C\x8B\x74\x24\x0C\x56\xE8\xF1\xE5\xFE\xFF\x8B"sv,
		0x63FB50),
	  codeHook.GetFuncRef(
		lua_getfield,
		"\x55\x8B\xEC\x83\xE4\xF8\x83\xEC\x08\x56\x8B\x75\x08\x57\xFF\x75"sv,
		0x63F910),
	  codeHook.GetFuncRef(
		lua_rawget,
		"\x56\x8B\x74\x24\x08\x57\xFF\x74\x24\x10\x56\xE8\xB0\xDB\xFE\xFF"sv,
		0x640590),
	  codeHook.GetFuncRef(
		lua_rawgeti,
		"\x55\x8B\xEC\x83\xE4\xF8\x83\xEC\x0C\x56\xFF\x75\x0C\x8B\x75\x08\x56"sv,
		0x6405C0),
	  codeHook.GetFuncRef(
		lua_createtable,
		"\x56\x8B\x74\x24\x08\x8B\x4E\x08\x8B\x41\x14\x3B\x41\x18\x72\x07"sv,
		0x63F640),
	  codeHook.GetFuncRef(
		lua_newuserdata,
		"\x56\x8B\x74\x24\x08\x8B\x4E\x08\x8B\x41\x14\x3B\x41\x18\x72\x07\x8B\xCE\xE8\xE9"sv,
		0x640090),
	  codeHook.GetFuncRef(
		lua_getmetatable,
		"\x56\xFF\x74\x24\x0C\x8B\x74\x24\x0C\x56\xE8\xC1\xE6\xFE\xFF\x8B"sv,
		0x63FA80),
	  codeHook.GetFuncRef(
		lua_getfenv,
		"\x56\xFF\x74\x24\x0C\x8B\x74\x24\x0C\x56\xE8\xA1\xE8\xFE\xFF\x8B"sv,
		0x63F8A0),
	  codeHook.GetFuncRef(
		lua_settable,
		"\x56\xFF\x74\x24\x0C\x8B\x74\x24\x0C\x56\xE8\xE1\xD5\xFE\xFF\x8B"sv,
		0x640B60),
	  codeHook.GetFuncRef(
		lua_setfield,
		"\x55\x8B\xEC\x83\xE4\xF8\x83\xEC\x10\x56\x8B\x75\x08\x57\xFF\x75"sv,
		0x6408E0),
	  codeHook.GetFuncRef(
		lua_rawset,
		"\x53\x56\x8B\x74\x24\x0C\x57\xFF\x74\x24\x14\x56\xE8\xBF\xDA\xFE"sv,
		0x640680),
	  codeHook.GetFuncRef(
		lua_rawseti,
		"\x53\x56\x8B\x74\x24\x0C\x57\xFF\x74\x24\x14\x56\xE8\x6F\xDA\xFE"sv,
		0x6406D0),
	  codeHook.GetFuncRef(
		lua_setmetatable,
		"\x53\x55\x56\x57\xFF\x74\x24\x18\x8B\x7C\x24\x18\x57\xE8\x0E\xD7"sv,
		0x640A30),
	  codeHook.GetFuncRef(
		lua_setfenv,
		"\x56\x8B\x74\x24\x08\x57\xFF\x74\x24\x10\x56\xE8\x00\xD9\xFE\xFF"sv,
		0x640840),
	  codeHook.GetFuncRef(
		lua_call,
		"\x8B\x44\x24\x08\x8B\x54\x24\x04\xFF\x44\x24\x0C\x8D\x0C\xC5\x00"sv,
		0x63F470),
	  codeHook.GetFuncRef(
		lua_pcall,
		"\x8B\x54\x24\x04\x8B\x4C\x24\x10\x53\x56\x8B\x72\x08\x8A\x5E\x71"sv,
		0x640230),
	  LuaReimplementation::NOTIMPL_lua_cpcall,
	  codeHook.GetFuncRef(
		lua_load,
		"\x6A\x00\xFF\x74\x24\x14\xFF\x74\x24\x14\xFF\x74\x24\x14\xFF\x74"sv,
		0x63FE00),
	  LuaReimplementation::lua_dump,
	  LuaReimplementation::NOTIMPL_lua_yield,
	  codeHook.GetFuncRef(
		lua_resume,
		"\x56\x8B\x74\x24\x08\x83\x7E\x28\x00\x75\x25\x8A\x46\x07\x3C\x01"sv,
		0x6407D0),
	  LuaReimplementation::lua_status,
	  codeHook.GetFuncRef(
		lua_next,
		"\x56\x8B\x74\x24\x08\x57\xFF\x74\x24\x10\x56\xE8\x30\xE0\xFE\xFF"sv,
		0x640110),
	  codeHook.GetFuncRef(
		lua_concat,
		"\x56\x8B\x74\x24\x0C\x83\xFE\x02\x7C\x60\x57\x8B\x7C\x24\x0C\x4E"sv,
		0x63F5A0),
	  codeHook.GetFuncRef(
		luaL_ref,
		"\x55\x8B\xEC\x83\xE4\xF8\x8B\x55\x0C\x83\xEC\x08\x8D\x82\x0F\x27"sv,
		0x63ED20),
	  codeHook.GetFuncRef(
		luaL_unref,
		"\x53\x8B\x5C\x24\x10\x85\xDB\x78\x67\x56\x8B\x74\x24\x0C\x57\x8B"sv,
		0x63F380),
	  LuaReimplementation::luaL_loadfile,
	  codeHook.GetFuncRef(
		luaL_loadbuffer,
		"\x83\xEC\x08\x8B\x44\x24\x10\x89\x04\x24\x8B\x44\x24\x14\x6A\x00"sv,
		0x63E5A0),
	  codeHook.GetFuncRef(
		luaL_loadstring,
		"\x8B\x54\x24\x08\x83\xEC\x08\x8B\xC2\x56\x8D\x70\x01\x8D\x49\x00"sv,
		0x63E710),
	  codeHook.GetFuncRef(
		luaL_newmetatable,
		"\x8B\x54\x24\x08\x53\x56\x8B\x74\x24\x0C\x8B\xCA\x8B\x46\x08\x57"sv,
		0x63E750),
	  LuaReimplementation::luaL_newstate,
	};
}

Payday2Handler::Payday2Handler(IRuntimeCodeHook& codeHook) :
  api{LoadLuaFunctions(codeHook)} {
	LuaFuncPtrs::inst = &api;
	OnTickHandler::Init(codeHook);
	OnNewStateHandler::Init(codeHook);
	OnCloseStateHandler::Init(codeHook);
}

const std::string& Payday2Handler::HandledAppName() const noexcept {
	return handledAppName;
}
